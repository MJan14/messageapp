<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fdf2f8">
    
    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155' }
                    },
                    boxShadow: {
                        'up': '0 -4px 6px -1px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* NATIVE APP FEEL CSS */
        * {
            -webkit-tap-highlight-color: transparent; /* No blue tap box */
            user-select: none; /* Prevent text selection on UI */
        }
        
        /* Allow text selection only in messages and inputs */
        .selectable, input { user-select: text; }

        body { 
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            overscroll-behavior-y: none; /* No bounce */
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .reaction-menu { transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom center; }
        .group:hover .reaction-menu { transform: scale(1); }
        .typing-dot { animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        @keyframes pop-heart {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.5); }
            100% { opacity: 0; transform: translate(-50%, -100%) scale(1); }
        }
        .animate-pop { animation: pop-heart 0.8s ease-out forwards; }

        /* Pop-in animation for the menu */
        @keyframes menu-pop {
            0% { opacity: 0; transform: scale(0.9) translateY(10px); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }
        .menu-animate { animation: menu-pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* iOS Safe Areas */
        .safe-pt { padding-top: max(12px, env(safe-area-inset-top)); }
        .safe-pb { padding-bottom: max(12px, env(safe-area-inset-bottom)); }
        
        .h-dvh { height: 100vh; height: 100dvh; }

        /* Glassmorphism Header */
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .dark .glass-header {
            background: rgba(15, 23, 42, 0.95);
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 transition-colors duration-200 overflow-hidden h-dvh flex flex-col">

    <audio id="notify-sound" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

    <!-- ERROR BANNER -->
    <div id="error-banner" class="hidden fixed top-0 left-0 w-full bg-red-500 text-white text-xs font-bold p-4 pt-12 text-center z-[100] shadow-lg cursor-pointer" onclick="this.classList.add('hidden')">
        ‚ö†Ô∏è Connection Blocked! Click here to close.
        <br><span class="font-normal opacity-90" id="error-text">Check Authorized Domains in Firebase.</span>
    </div>

    <!-- OVERLAY (For closing menus) -->
    <div id="menu-overlay" class="hidden fixed inset-0 z-[45] bg-black/10 backdrop-blur-[1px] transition-opacity"></div>

    <!-- MOMENTS/DATES MODAL -->
    <div id="countdown-modal" class="hidden fixed inset-0 z-[80] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
        <div class="bg-white dark:bg-slate-800 w-[85%] max-w-[340px] sm:max-w-sm rounded-3xl shadow-2xl p-5 sm:p-6 relative border-2 border-pink-100 dark:border-slate-700 max-h-[85vh] overflow-y-auto">
            <button id="close-countdown" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
                <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
            
            <!-- Together Since Section -->
            <div class="text-center mb-6">
                <h3 class="text-xl font-black text-pink-500 dark:text-pink-400 mb-4 uppercase tracking-widest">Together Since</h3>
                
                <div id="together-display" class="hidden bg-gradient-to-br from-pink-500 to-rose-500 text-white p-4 rounded-2xl shadow-lg mb-4 transform transition-all hover:scale-105">
                    <div id="together-timer" class="font-bold text-lg leading-relaxed">Calculating...</div>
                </div>

                <div class="flex gap-2 justify-center">
                    <input type="date" id="together-date-input" class="bg-gray-100 dark:bg-slate-900 border border-gray-100 dark:border-slate-700 rounded-xl px-3 py-2 text-xs text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <button id="save-together-btn" class="bg-gray-800 dark:bg-white dark:text-slate-900 text-white px-3 py-2 rounded-xl text-xs font-bold shadow-md active:scale-95 transition-transform">Set Date</button>
                </div>
            </div>

            <hr class="border-gray-100 dark:border-slate-700 my-4">

            <!-- Upcoming Event Section -->
            <div class="text-center">
                <p class="text-xs text-gray-400 uppercase tracking-widest mb-2">Next Special Date</p>
                
                <div id="active-countdown" class="hidden mb-4 text-center bg-pink-50 dark:bg-slate-700/50 p-3 rounded-2xl border border-pink-100 dark:border-slate-600">
                    <div id="countdown-title-display" class="text-sm font-bold text-pink-500 mb-1">Anniversary</div>
                    <div id="countdown-timer-display" class="text-2xl font-black text-gray-800 dark:text-white">0 Days</div>
                    <div id="countdown-subtext" class="text-[10px] text-gray-500 dark:text-gray-400">left</div>
                </div>

                <form id="countdown-form" class="space-y-3">
                    <input type="text" id="countdown-title-input" placeholder="Event Name (e.g. Anniversary)" class="w-full bg-gray-100 dark:bg-slate-900 border border-gray-100 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <input type="date" id="countdown-date-input" class="w-full bg-gray-100 dark:bg-slate-900 border border-gray-100 dark:border-slate-700 rounded-xl px-4 py-2.5 text-sm text-gray-800 dark:text-white focus:outline-none focus:ring-2 focus:ring-pink-400">
                    <button type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-2.5 rounded-xl transition-all shadow-md active:scale-95 text-sm">Save Event</button>
                </form>
            </div>
        </div>
    </div>

    <!-- CALL MODAL -->
    <div id="call-modal" class="hidden fixed inset-0 z-[100] bg-black flex flex-col animate-in fade-in duration-300">
        <div class="bg-black/50 backdrop-blur-md text-white p-4 pt-safe-top flex justify-between items-center relative z-10">
            <span class="font-bold flex items-center gap-2"><span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span> Video Call</span>
            <button id="end-call-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-full text-sm font-bold shadow-lg transition-transform active:scale-95">End</button>
        </div>
        <div id="jitsi-container" class="flex-1 w-full h-full relative bg-gray-900">
            <div class="absolute inset-0 flex items-center justify-center text-gray-500">Connecting securely...</div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden fixed inset-0 z-50 flex-col items-center justify-center bg-gradient-to-b from-pink-50 to-white dark:from-slate-900 dark:to-slate-800 p-6 transition-colors">
        <div class="w-full max-w-sm text-center">
            <div class="relative w-28 h-28 mx-auto mb-8 group cursor-pointer transition-transform active:scale-95" onclick="document.getElementById('login-avatar-input').click()">
                <div id="login-avatar-preview" class="w-full h-full rounded-full bg-pink-100 dark:bg-slate-700 overflow-hidden border-[6px] border-white dark:border-slate-600 shadow-xl flex items-center justify-center">
                    <svg class="w-12 h-12 text-pink-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
                <div class="absolute bottom-1 right-1 bg-pink-500 text-white p-2 rounded-full shadow-lg border-2 border-white dark:border-slate-800">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <input type="file" id="login-avatar-input" accept="image/*" class="hidden">
            </div>
            <h1 class="text-4xl font-extrabold text-gray-800 dark:text-white mb-2 tracking-tight">Chat</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-10 text-lg">Your private space.</p>
            <div id="connection-status" class="mb-4 text-sm font-medium text-yellow-600 bg-yellow-50 py-2 px-3 rounded-lg hidden">Connecting...</div>
            <form id="login-form" class="space-y-4">
                <input type="text" id="username-input" placeholder="Your Name" class="w-full px-6 py-4 text-lg border-none bg-white dark:bg-slate-700 shadow-lg rounded-2xl focus:ring-4 focus:ring-pink-100 dark:focus:ring-slate-600 text-gray-800 dark:text-white placeholder-gray-400 transition-all text-center font-semibold" required>
                <button type="submit" id="login-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold text-lg py-4 rounded-2xl shadow-xl shadow-pink-200 dark:shadow-none disabled:opacity-50 cursor-pointer active:scale-[0.98] transition-all">Start Chatting</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="hidden flex-col h-full w-full relative">
        <!-- Header -->
        <header class="glass-header px-4 py-3 safe-pt shadow-[0_1px_0_0_rgba(0,0,0,0.05)] dark:shadow-[0_1px_0_0_rgba(255,255,255,0.05)] z-40 absolute top-0 w-full transition-all duration-300" id="main-header">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div id="header-avatar" class="w-9 h-9 rounded-full bg-gradient-to-tr from-pink-400 to-rose-500 flex items-center justify-center text-white font-bold shadow-sm overflow-hidden text-sm"></div>
                    <div>
                        <h2 class="font-bold text-lg text-gray-900 dark:text-white flex items-center gap-1 leading-tight">Chat <span class="text-pink-500 text-xs">‚ù§Ô∏è</span></h2>
                        <p class="text-[10px] text-green-500 flex items-center gap-1 font-bold uppercase tracking-wider leading-tight"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</p>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button id="search-toggle-btn" class="p-2.5 text-gray-400 hover:text-pink-500 hover:bg-pink-50 dark:hover:bg-slate-700/50 rounded-full cursor-pointer transition-colors active:scale-90" title="Search">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </button>
                    <button id="countdown-btn" class="p-2.5 text-gray-400 hover:text-pink-500 hover:bg-pink-50 dark:hover:bg-slate-700/50 rounded-full cursor-pointer transition-colors active:scale-90" title="Moments">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                    </button>
                    <button id="video-call-btn" class="p-2.5 text-pink-500 hover:bg-pink-50 dark:hover:bg-slate-700/50 rounded-full cursor-pointer transition-colors active:scale-90" title="Video Call">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>
                    </button>
                    <button id="theme-toggle" class="p-2.5 text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700/50 rounded-full cursor-pointer active:scale-90 transition-transform">
                        <svg id="moon-icon" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                        <svg id="sun-icon" class="w-6 h-6 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                    </button>
                    <button id="logout-btn" class="p-2.5 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-slate-700/50 rounded-full cursor-pointer active:scale-90 transition-transform">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    </button>
                </div>
            </div>
            
            <!-- SEARCH BAR (Hidden by default) -->
            <div id="search-bar-container" class="hidden mt-2 animate-in slide-in-from-top-2 fade-in duration-200">
                <div class="relative">
                    <input type="text" id="search-input" placeholder="Search history..." class="w-full bg-gray-100 dark:bg-slate-700 border-none rounded-xl pl-10 pr-4 py-2 text-sm text-gray-800 dark:text-white focus:ring-2 focus:ring-pink-300">
                    <svg class="w-4 h-4 text-gray-400 absolute left-3 top-2.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <button id="close-search" class="absolute right-2 top-2 text-gray-400 hover:text-gray-600 p-0.5"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 min-h-0 overflow-y-auto pt-24 pb-4 px-4 space-y-3 bg-slate-50 dark:bg-slate-900 relative scroll-smooth z-0">
            <!-- Pinned Message -->
            <div id="pinned-message-container" class="hidden sticky top-0 z-30 mb-2 -mx-2 px-2">
                <div class="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-400 rounded-r-lg p-2 shadow-sm flex items-center justify-between backdrop-blur-sm">
                    <div class="flex-1 min-w-0 pr-2">
                        <p class="text-[10px] font-bold text-yellow-600 dark:text-yellow-500 uppercase tracking-wider mb-0.5">üìå Pinned Message</p>
                        <p id="pinned-text" class="text-xs text-gray-700 dark:text-gray-200 truncate font-medium">Loading...</p>
                    </div>
                    <button id="unpin-btn" class="p-1.5 text-gray-400 hover:text-red-500 rounded-full hover:bg-black/5 dark:hover:bg-white/5"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
            </div>

            <div id="messages-list" class="max-w-3xl mx-auto w-full space-y-3 pb-4"></div>
            
            <div id="typing-indicator" class="hidden absolute bottom-4 left-6 z-10 text-[10px] font-bold text-gray-400 dark:text-gray-500 bg-white/80 dark:bg-slate-800/80 px-3 py-1 rounded-full backdrop-blur-sm shadow-sm animate-pulse flex items-center gap-1">
                <span id="typing-names">Someone</span> is typing...
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white/95 dark:bg-slate-900/95 backdrop-blur-lg p-2 safe-pb border-t border-gray-100 dark:border-slate-800 w-full z-50 relative">
            <div class="max-w-3xl mx-auto w-full">
                <div id="reply-preview" class="hidden flex items-center justify-between bg-gray-50 dark:bg-slate-800/50 p-2 px-4 rounded-xl border-l-4 border-pink-500 mb-2 text-xs mx-1">
                    <div class="overflow-hidden"><p class="font-bold text-pink-500 mb-0.5">Replying to <span id="reply-to-name">User</span></p><p id="reply-to-text" class="text-gray-600 dark:text-gray-400 truncate">...</p></div>
                    <button id="cancel-reply" class="p-1 hover:bg-black/10 rounded-full cursor-pointer"><svg class="w-4 h-4 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
                
                <!-- EDIT MODE BANNER (Replaces reply preview when editing) -->
                <div id="edit-preview" class="hidden flex items-center justify-between bg-yellow-50 dark:bg-yellow-900/20 p-2 px-4 rounded-xl border-l-4 border-yellow-500 mb-2 text-xs mx-1">
                    <div class="overflow-hidden"><p class="font-bold text-yellow-600 dark:text-yellow-500 mb-0.5">Editing Message</p></div>
                    <button id="cancel-edit" class="p-1 hover:bg-black/10 rounded-full cursor-pointer text-yellow-600"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>

                <div id="message-input-area" class="flex items-end gap-2 p-1">
                    <div class="flex items-center gap-1 pb-1">
                        <input type="file" id="image-input" accept="image/*" class="hidden">
                        <button id="image-btn" class="p-2.5 text-gray-400 hover:text-pink-500 hover:bg-gray-100 dark:hover:bg-slate-800 rounded-full transition-all active:scale-90" title="Photo"><svg class="w-6 h-6 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></button>
                    </div>
                    <div id="input-container" class="flex-1 bg-gray-100 dark:bg-slate-800 rounded-[20px] border border-transparent focus-within:border-pink-300 dark:focus-within:border-slate-600 focus-within:ring-2 focus-within:ring-pink-100 dark:focus-within:ring-slate-700 transition-all flex items-center min-h-[44px]">
                        <input type="text" id="message-input" class="w-full bg-transparent border-none outline-none text-gray-800 dark:text-gray-100 placeholder-gray-400 text-[16px] px-4 py-2.5 leading-normal" placeholder="Message..." autocomplete="off">
                    </div>
                    <div class="pb-0.5">
                        <button id="send-btn" type="button" class="hidden bg-pink-500 hover:bg-pink-600 text-white p-2.5 rounded-full shadow-lg shadow-pink-200 dark:shadow-none transition-transform active:scale-90 disabled:bg-gray-400 cursor-pointer">
                            <!-- Icon changes based on mode (Send vs Save) -->
                            <svg id="send-icon" class="w-5 h-5 ml-0.5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                            <svg id="save-icon" class="hidden w-5 h-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                        </button>
                        <button id="mic-btn" type="button" class="bg-gray-200 dark:bg-slate-800 hover:bg-gray-300 text-gray-500 dark:text-gray-400 p-2.5 rounded-full transition-transform active:scale-90 cursor-pointer">
                            <svg class="w-5 h-5 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-slate-900"><svg class="w-16 h-16 text-pink-500 animate-pulse fill-current" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCuDu_yuMRmXTi7N3tdMJckLnuHyQ2tcsc",
            authDomain: "messageapp-98066.firebaseapp.com",
            projectId: "messageapp-98066",
            storageBucket: "messageapp-98066.firebasestorage.app",
            messagingSenderId: "647948804998",
            appId: "1:647948804998:web:bd0eebd3f97f9853f18207",
            measurementId: "G-H096MFHK6K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "love-chat";

        const els = {
            loginScreen: document.getElementById('login-screen'),
            appScreen: document.getElementById('app-screen'),
            loadingScreen: document.getElementById('loading-screen'),
            errorBanner: document.getElementById('error-banner'),
            errorText: document.getElementById('error-text'),
            loginForm: document.getElementById('login-form'),
            username: document.getElementById('username-input'),
            msgInput: document.getElementById('message-input'),
            msgList: document.getElementById('messages-list'),
            msgContainer: document.getElementById('messages-container'),
            headerAvatar: document.getElementById('header-avatar'),
            avatarPreview: document.getElementById('login-avatar-preview'),
            avatarInput: document.getElementById('login-avatar-input'),
            sendBtn: document.getElementById('send-btn'),
            sendIcon: document.getElementById('send-icon'),
            saveIcon: document.getElementById('save-icon'),
            micBtn: document.getElementById('mic-btn'),
            replyPreview: document.getElementById('reply-preview'),
            replyName: document.getElementById('reply-to-name'),
            replyText: document.getElementById('reply-to-text'),
            cancelReply: document.getElementById('cancel-reply'),
            editPreview: document.getElementById('edit-preview'),
            cancelEdit: document.getElementById('cancel-edit'),
            inputContainer: document.getElementById('input-container'),
            imgInput: document.getElementById('image-input'),
            imgBtn: document.getElementById('image-btn'),
            typing: document.getElementById('typing-indicator'),
            typingName: document.getElementById('typing-names'),
            notifySound: document.getElementById('notify-sound'),
            logoutBtn: document.getElementById('logout-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            moon: document.getElementById('moon-icon'),
            sun: document.getElementById('sun-icon'),
            videoBtn: document.getElementById('video-call-btn'),
            callModal: document.getElementById('call-modal'),
            endCallBtn: document.getElementById('end-call-btn'),
            jitsiContainer: document.getElementById('jitsi-container'),
            pinnedContainer: document.getElementById('pinned-message-container'),
            pinnedText: document.getElementById('pinned-text'),
            unpinBtn: document.getElementById('unpin-btn'),
            countdownBtn: document.getElementById('countdown-btn'),
            countdownModal: document.getElementById('countdown-modal'),
            closeCountdown: document.getElementById('close-countdown'),
            countdownForm: document.getElementById('countdown-form'),
            activeCountdown: document.getElementById('active-countdown'),
            cdTitleDisplay: document.getElementById('countdown-title-display'),
            cdTimerDisplay: document.getElementById('countdown-timer-display'),
            cdSubtext: document.getElementById('countdown-subtext'),
            menuOverlay: document.getElementById('menu-overlay'),
            searchToggle: document.getElementById('search-toggle-btn'),
            searchContainer: document.getElementById('search-bar-container'),
            searchInput: document.getElementById('search-input'),
            closeSearch: document.getElementById('close-search'),
            togetherDisplay: document.getElementById('together-display'),
            togetherTimer: document.getElementById('together-timer'),
            togetherInput: document.getElementById('together-date-input'),
            saveTogetherBtn: document.getElementById('save-together-btn')
        };

        let state = {
            user: null,
            username: localStorage.getItem('chat_username') || '',
            avatar: localStorage.getItem('chat_avatar') || null,
            replyingTo: null,
            editingMsgId: null, // Track editing state
            searchQuery: '', // Track search
            typingTimer: null,
            mediaRecorder: null,
            audioChunks: [],
            pinnedMsgId: null,
            longPressTimer: null,
            allMessages: [] // Store all msgs for searching
        };

        let isFirstRender = true;

        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                els.moon.classList.add('hidden');
                els.sun.classList.remove('hidden');
            }
        }
        initTheme();

        onAuthStateChanged(auth, (u) => {
            state.user = u;
            els.loadingScreen.classList.add('hidden');
            if (u) {
                if (state.username) showApp();
                else showLogin();
            } else {
                signInAnonymously(auth).catch(err => {
                    els.errorBanner.classList.remove('hidden');
                    els.errorText.textContent = "Auth failed: " + err.message;
                });
                showLogin();
            }
        });

        function showLogin() {
            els.loginScreen.classList.remove('hidden');
            els.loginScreen.classList.add('flex');
            els.appScreen.classList.add('hidden');
            els.appScreen.classList.remove('flex');
        }

        function showApp() {
            els.loginScreen.classList.add('hidden');
            els.loginScreen.classList.remove('flex');
            els.appScreen.classList.remove('hidden');
            els.appScreen.classList.add('flex');
            if (state.avatar) els.headerAvatar.innerHTML = `<img src="${state.avatar}" class="w-full h-full object-cover">`;
            else els.headerAvatar.textContent = state.username.charAt(0).toUpperCase();
            if (Notification.permission === 'default') setTimeout(() => Notification.requestPermission(), 1000);
            startMessageListener();
            startTypingListener();
            startSettingsListener();
        }

        els.avatarInput.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                const base64 = await compressImage(e.target.files[0], 150);
                state.avatar = base64;
                els.avatarPreview.innerHTML = `<img src="${base64}" class="w-full h-full object-cover">`;
            }
        });

        els.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const val = els.username.value.trim();
            if (!val) return;
            state.username = val;
            localStorage.setItem('chat_username', val);
            if (state.avatar) localStorage.setItem('chat_avatar', state.avatar);
            if (state.user) showApp();
        });

        els.logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('chat_username');
            localStorage.removeItem('chat_avatar');
            state.username = '';
            state.avatar = null;
            showLogin();
        });

        els.themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            els.moon.classList.toggle('hidden');
            els.sun.classList.toggle('hidden');
        });

        els.videoBtn.addEventListener('click', () => {
            if (confirm("Start a video call?")) {
                sendMessage('call', 'Started a video call');
                startJitsiCall();
            }
        });

        els.endCallBtn.addEventListener('click', () => {
            els.callModal.classList.add('hidden');
            els.jitsiContainer.innerHTML = '<div class="absolute inset-0 flex items-center justify-center text-gray-500">Connecting securely...</div>';
        });

        window.joinCall = () => startJitsiCall();

        function startJitsiCall() {
            els.callModal.classList.remove('hidden');
            const roomName = `LoveChat_Room_${appId}`;
            const domain = 'meet.jit.si';
            setTimeout(() => {
                els.jitsiContainer.innerHTML = "";
                const iframe = document.createElement('iframe');
                iframe.src = `https://${domain}/${roomName}#jitsi_meet_external_api_id=0&config.prejoinPageEnabled=false&interfaceConfig.TOOLBAR_BUTTONS=['microphone','camera','hangup','chat','tileview']`;
                iframe.style.width = "100%";
                iframe.style.height = "100%";
                iframe.style.border = "0";
                iframe.allow = "camera; microphone; display-capture; autoplay; clipboard-write";
                els.jitsiContainer.appendChild(iframe);
            }, 100);
        }

        // --- SETTINGS (PIN, COUNTDOWN, TOGETHER) ---
        function startSettingsListener() {
            const settingsRef = collection(db, 'artifacts', appId, 'public', 'data', 'settings');
            onSnapshot(settingsRef, (snap) => {
                snap.forEach(d => {
                    const data = d.data();
                    if (d.id === 'pinned') updatePinnedUI(data);
                    if (d.id === 'countdown') updateCountdownUI(data);
                    if (d.id === 'together') updateTogetherUI(data);
                });
            });
        }

        function updatePinnedUI(data) {
            if (data && data.text) {
                els.pinnedContainer.classList.remove('hidden');
                els.pinnedText.textContent = data.text;
                state.pinnedMsgId = data.id;
            } else {
                els.pinnedContainer.classList.add('hidden');
                state.pinnedMsgId = null;
            }
        }

        async function setPinned(id, text, sender) {
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pinned'), {
                    id, text: `${sender}: ${text}`, timestamp: Date.now()
                });
            } catch(e) {}
        }

        els.unpinBtn.addEventListener('click', async () => {
            if (confirm("Unpin message?")) {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'pinned'), {});
                } catch(e) {}
            }
        });

        // --- MOMENTS MODAL ---
        els.countdownBtn.addEventListener('click', () => els.countdownModal.classList.remove('hidden'));
        els.closeCountdown.addEventListener('click', () => els.countdownModal.classList.add('hidden'));

        // Countdown Logic
        els.countdownForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('countdown-title-input').value;
            const date = document.getElementById('countdown-date-input').value;
            if (!title || !date) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'countdown'), { title, date });
                alert("Date saved!");
            } catch(e) { alert("Error saving date"); }
        });

        function updateCountdownUI(data) {
            if (!data || !data.date) return;
            els.activeCountdown.classList.remove('hidden');
            els.cdTitleDisplay.textContent = data.title;
            const target = new Date(data.date).getTime();
            
            // Clear existing interval if any (not implemented for simplicity, just overwrite)
            if (state.cdInterval) clearInterval(state.cdInterval);
            
            calcTime();
            state.cdInterval = setInterval(calcTime, 60000);
            function calcTime() {
                const now = new Date().getTime();
                const diff = target - now;
                const isFuture = diff > 0;
                const absDiff = Math.abs(diff);
                const days = Math.floor(absDiff / (1000 * 60 * 60 * 24));
                els.cdTimerDisplay.textContent = `${days} Days`;
                els.cdSubtext.textContent = isFuture ? "until event" : "since event";
            }
        }

        // Together Since Logic
        els.saveTogetherBtn.addEventListener('click', async () => {
            const date = els.togetherInput.value;
            if (!date) return;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'together'), { date });
            } catch(e) { console.error(e); }
        });

        function updateTogetherUI(data) {
            if (!data || !data.date) return;
            els.togetherDisplay.classList.remove('hidden');
            
            if (state.togetherInterval) clearInterval(state.togetherInterval);
            
            const start = new Date(data.date);
            
            calcTogether();
            state.togetherInterval = setInterval(calcTogether, 60000); // Update every minute

            function calcTogether() {
                const now = new Date();
                let years = now.getFullYear() - start.getFullYear();
                let months = now.getMonth() - start.getMonth();
                let days = now.getDate() - start.getDate();

                if (days < 0) {
                    months--;
                    // Get days in previous month
                    const prevMonth = new Date(now.getFullYear(), now.getMonth(), 0).getDate();
                    days += prevMonth;
                }
                if (months < 0) {
                    years--;
                    months += 12;
                }
                
                let text = "";
                if (years > 0) text += `${years}Y `;
                if (months > 0 || years > 0) text += `${months}M `;
                text += `${days}D`;
                
                els.togetherTimer.textContent = text;
            }
        }

        // --- SEARCH LOGIC ---
        els.searchToggle.addEventListener('click', () => {
            els.searchContainer.classList.remove('hidden');
            els.searchInput.focus();
        });
        
        els.closeSearch.addEventListener('click', () => {
            els.searchContainer.classList.add('hidden');
            state.searchQuery = '';
            els.searchInput.value = '';
            renderMessages(state.allMessages); // Restore all
        });

        els.searchInput.addEventListener('input', (e) => {
            state.searchQuery = e.target.value.toLowerCase();
            const filtered = state.allMessages.filter(msg => {
                if (!msg.text) return false;
                return msg.text.toLowerCase().includes(state.searchQuery);
            });
            renderMessages(filtered);
        });

        // --- MESSAGING LOGIC ---
        function startMessageListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
            onSnapshot(q, (snapshot) => {
                els.errorBanner.classList.add('hidden');
                const msgs = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => (a.timestamp || 0) - (b.timestamp || 0));
                
                state.allMessages = msgs; // Store for search

                // Logic for new messages
                if (!isFirstRender && !state.searchQuery) { // Don't notify if searching or first load
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === 'added') {
                            const data = change.doc.data();
                            if (data.sender !== state.username && (Date.now() - data.timestamp) < 5000) {
                                els.notifySound.play().catch(e=>{});
                                if (Notification.permission === "granted" && document.visibilityState === "hidden") {
                                    try { new Notification(data.sender, { body: data.text }); } catch(e){}
                                }
                            }
                            if (data.sender !== state.username && !data.read) {
                                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat_messages', change.doc.id), { read: true }).catch(e=>{});
                            }
                        }
                    });
                }
                
                // If searching, filter again with new data
                if (state.searchQuery) {
                    const filtered = msgs.filter(msg => msg.text && msg.text.toLowerCase().includes(state.searchQuery));
                    renderMessages(filtered);
                } else {
                    renderMessages(msgs);
                }
            }, (error) => {
                els.errorBanner.classList.remove('hidden');
                els.errorText.textContent = "Connection Lost. " + error.message;
            });
        }

        function renderMessages(msgs) {
            let html = '';
            let lastDate = null;

            msgs.forEach(msg => {
                const isMe = msg.sender === state.username;
                const date = new Date(msg.timestamp);
                const dayStr = date.toLocaleDateString();
                
                if (dayStr !== lastDate) {
                    let label = dayStr;
                    const today = new Date().toLocaleDateString();
                    if (dayStr === today) label = "Today";
                    html += `<div class="flex justify-center my-4"><span class="bg-gray-100 dark:bg-slate-800 text-gray-500 text-[10px] font-bold px-3 py-1 rounded-full uppercase tracking-wider">${label}</span></div>`;
                    lastDate = dayStr;
                }

                const avatarHtml = !isMe 
                    ? `<div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-slate-700 overflow-hidden flex-shrink-0 mt-auto mb-1 shadow-sm border border-white dark:border-slate-600">
                        ${msg.senderAvatar ? `<img src="${msg.senderAvatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] font-bold text-gray-500">${msg.sender[0]}</div>`}
                       </div>` 
                    : '';
                
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                let ticks = '';
                if (isMe) {
                    if (msg.read) ticks = `<span class="text-pink-500 ml-1 flex -space-x-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>`;
                    else ticks = `<span class="text-gray-400 ml-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>`;
                }

                let content = `<p class="selectable">${msg.text} ${msg.edited ? '<span class="text-[9px] opacity-50 italic">(edited)</span>' : ''}</p>`;
                if (msg.deleted) content = `<p class="italic opacity-60 text-sm flex items-center gap-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Deleted</p>`;
                else if (msg.type === 'image') content = `<img src="${msg.imageUrl}" class="rounded-lg max-h-64 w-auto border border-black/5 dark:border-white/10">`;
                else if (msg.type === 'audio') content = `<audio controls src="${msg.audioUrl}" class="h-8 w-48"></audio>`;
                else if (msg.type === 'call') content = `
                    <div class="flex flex-col gap-2">
                        <div class="font-bold flex items-center gap-2">üìû Video Call</div>
                        <button onclick="window.joinCall()" class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-green-600 transition-colors">Join Call</button>
                    </div>
                `;

                let reply = '';
                if (msg.replyToText && !msg.deleted) {
                    reply = `<div class="mb-1 text-[10px] opacity-70 border-l-2 border-current pl-2 truncate cursor-pointer bg-black/5 dark:bg-white/5 rounded-r p-1"><b>${msg.replyToSender}</b>: ${msg.replyToText}</div>`;
                }

                const encodedText = encodeURIComponent(msg.text || '');
                // ACTION MENU - FIXED: Removed stopPropagation so clicks bubble up
                const actionMenu = !msg.deleted ? `
                    <div class="hidden absolute -top-12 ${isMe ? 'right-0' : 'left-0'} bg-white dark:bg-slate-700 shadow-2xl rounded-2xl p-2 border border-gray-100 dark:border-slate-600 z-50 flex flex-col gap-2 menu-animate reaction-menu-container min-w-[200px]">
                        <div class="flex justify-between items-center gap-2 px-1 pb-2 border-b border-gray-100 dark:border-slate-600">
                            <button data-action="react" data-id="${msg.id}" data-emoji="‚ù§Ô∏è" class="text-2xl hover:scale-125 transition-transform active:scale-95">‚ù§Ô∏è</button>
                            <button data-action="react" data-id="${msg.id}" data-emoji="üòÇ" class="text-2xl hover:scale-125 transition-transform active:scale-95">üòÇ</button>
                            <button data-action="react" data-id="${msg.id}" data-emoji="üò¢" class="text-2xl hover:scale-125 transition-transform active:scale-95">üò¢</button>
                            <button data-action="react" data-id="${msg.id}" data-emoji="üò†" class="text-2xl hover:scale-125 transition-transform active:scale-95">üò†</button>
                            <button data-action="react" data-id="${msg.id}" data-emoji="üëç" class="text-2xl hover:scale-125 transition-transform active:scale-95">üëç</button>
                        </div>
                        <div class="flex justify-around items-center pt-1 text-xs font-bold text-gray-500 dark:text-gray-300">
                            <button data-action="reply" data-id="${msg.id}" data-sender="${msg.sender}" data-type="${msg.type}" data-text="${encodedText}" class="flex flex-col items-center gap-1 hover:text-pink-500 transition-colors p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 w-full">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14L4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg> Reply
                            </button>
                            <button data-action="copy" data-text="${encodedText}" class="flex flex-col items-center gap-1 hover:text-blue-500 transition-colors p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 w-full">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg> Copy
                            </button>
                            <button data-action="pin" data-id="${msg.id}" data-text="${encodedText}" data-sender="${msg.sender}" class="flex flex-col items-center gap-1 hover:text-yellow-500 transition-colors p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 w-full">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="17" x2="12" y2="3"></line><path d="M5 17h14v4H5z"></path><path d="M15 17L9 3"></path></svg> Pin
                            </button>
                            ${isMe && msg.type === 'text' ? `<button data-action="edit" data-id="${msg.id}" data-text="${encodedText}" class="flex flex-col items-center gap-1 hover:text-green-500 transition-colors p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 w-full"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg> Edit</button>` : ''}
                            ${isMe ? `<button data-action="delete" data-id="${msg.id}" class="flex flex-col items-center gap-1 hover:text-red-500 transition-colors p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-slate-600 w-full"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg> Del</button>` : ''}
                        </div>
                    </div>` : '';

                let reactionsHtml = '';
                if (!msg.deleted && msg.reactions) {
                    const reactCounts = {};
                    Object.values(msg.reactions).forEach(r => reactCounts[r] = (reactCounts[r] || 0) + 1);
                    if (Object.keys(reactCounts).length > 0) {
                        reactionsHtml = `<div class="flex flex-wrap gap-1 mt-1 justify-end absolute -bottom-3 right-0 pointer-events-none">`;
                        for (const [emoji, count] of Object.entries(reactCounts)) reactionsHtml += `<span class="text-[10px] bg-white dark:bg-slate-700 border border-gray-100 dark:border-slate-600 px-1.5 py-0.5 rounded-full shadow-sm z-10">${emoji} ${count > 1 ? count : ''}</span>`;
                        reactionsHtml += `</div>`;
                    }
                }

                html += `
                    <div class="flex gap-2 ${isMe ? 'justify-end' : 'justify-start'} group mb-4 relative px-2 message-bubble-container" oncontextmenu="return false;">
                        ${!isMe ? avatarHtml : ''}
                        <div class="max-w-[75%] relative">
                            <div class="px-3.5 py-2.5 rounded-[20px] shadow-sm text-[15px] leading-relaxed ${isMe ? 'bg-pink-500 text-white rounded-br-sm' : 'bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-100 rounded-bl-sm'} border border-transparent ${!isMe ? 'dark:border-slate-700' : ''} touch-manipulation message-bubble" data-msg-id="${msg.id}">
                                ${reply}
                                ${content}
                                ${reactionsHtml}
                                <div class="flex items-center justify-end gap-1 mt-0.5">
                                    <span class="text-[9px] opacity-70">${timeStr}</span>
                                    ${ticks}
                                </div>
                            </div>
                            ${actionMenu}
                        </div>
                    </div>
                `;
            });
            els.msgList.innerHTML = html;

            if (isFirstRender) {
                els.msgContainer.style.scrollBehavior = 'auto';
                els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
                setTimeout(() => {
                    els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
                    els.msgContainer.style.scrollBehavior = 'smooth';
                }, 300);
                isFirstRender = false;
            } else {
                // If searching, don't auto scroll unless near bottom
                if (!state.searchQuery && els.msgContainer.scrollTop + els.msgContainer.clientHeight >= els.msgContainer.scrollHeight - 200) {
                    els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
                }
            }
            
            // Re-attach long press listeners to new elements
            document.querySelectorAll('.message-bubble').forEach(el => {
                el.addEventListener('mousedown', handleStartPress);
                el.addEventListener('touchstart', handleStartPress);
                el.addEventListener('mouseup', handleEndPress);
                el.addEventListener('touchend', handleEndPress);
                el.addEventListener('mouseleave', handleEndPress);
                el.addEventListener('touchmove', handleEndPress);
            });
        }

        // --- LONG PRESS LOGIC ---
        function handleStartPress(e) {
            state.longPressTimer = setTimeout(() => {
                showMenu(e.target.closest('.message-bubble-container'));
            }, 500); 
        }

        function handleEndPress(e) {
            if (state.longPressTimer) {
                clearTimeout(state.longPressTimer);
                state.longPressTimer = null;
            }
        }

        function showMenu(container) {
            // Close others first
            closeAllMenus();
            
            if (container) {
                const menu = container.querySelector('.reaction-menu-container');
                if (menu) {
                    menu.classList.remove('hidden');
                    els.menuOverlay.classList.remove('hidden');
                    // Vibration feedback
                    if (navigator.vibrate) navigator.vibrate(50);
                }
            }
        }

        function closeAllMenus() {
            document.querySelectorAll('.reaction-menu-container').forEach(el => el.classList.add('hidden'));
            els.menuOverlay.classList.add('hidden');
        }

        // Global click handler to close menu
        els.menuOverlay.addEventListener('click', closeAllMenus);

        async function sendReaction(id, emoji) {
            if (!state.user) return;
            try {
                if (emoji === '‚ù§Ô∏è') {
                    const bubble = document.querySelector(`[data-msg-id="${id}"]`);
                    if (bubble) showHeartAnimation(bubble);
                }
                const msgRef = doc(db, 'artifacts', appId, 'public', 'data', 'chat_messages', id);
                await updateDoc(msgRef, { [`reactions.${state.user.uid}`]: emoji });
            } catch (e) {}
        }

        function showHeartAnimation(element) {
            const heart = document.createElement('div');
            heart.textContent = '‚ù§Ô∏è';
            heart.className = 'fixed text-6xl pointer-events-none animate-pop z-[60]';
            const rect = element.getBoundingClientRect();
            heart.style.left = (rect.left + rect.width / 2) + 'px';
            heart.style.top = (rect.top + rect.height / 2) + 'px';
            document.body.appendChild(heart);
            setTimeout(() => heart.remove(), 1000);
        }

        // ACTIONS (Edit, Delete, Copy, Etc)
        els.msgList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            
            // Actions that close the menu immediately
            if (action) closeAllMenus();

            if (action === 'edit') {
                const text = decodeURIComponent(btn.dataset.text);
                startEditing(btn.dataset.id, text);
            }
            if (action === 'copy') {
                const text = decodeURIComponent(btn.dataset.text);
                navigator.clipboard.writeText(text);
                alert("Copied!");
            }
            if (action === 'pin') {
                const text = decodeURIComponent(btn.dataset.text);
                const sender = btn.dataset.sender;
                setPinned(btn.dataset.id, text, sender);
            }
            if (action === 'reply') {
                const text = decodeURIComponent(btn.dataset.text);
                const type = btn.dataset.type;
                const displayText = type === 'image' ? 'Photo' : (type === 'audio' ? 'Voice Note' : (type === 'call' ? 'Call' : text));
                state.replyingTo = { id: btn.dataset.id, sender: btn.dataset.sender, text: displayText };
                els.replyPreview.classList.remove('hidden');
                els.replyPreview.classList.add('flex');
                els.replyName.textContent = btn.dataset.sender;
                els.replyText.textContent = displayText;
                els.msgInput.focus();
            }
            if (action === 'delete' && confirm("Delete message?")) {
                updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat_messages', btn.dataset.id), { deleted: true, text: 'Deleted', imageUrl: null, audioUrl: null });
            }
            if (action === 'react') sendReaction(btn.dataset.id, btn.dataset.emoji);
        });

        els.msgList.addEventListener('dblclick', (e) => {
            const bubble = e.target.closest('[data-msg-id]');
            if (bubble) sendReaction(bubble.dataset.msgId, '‚ù§Ô∏è');
        });

        els.cancelReply.addEventListener('click', () => {
            state.replyingTo = null;
            els.replyPreview.classList.add('hidden');
            els.replyPreview.classList.remove('flex');
        });

        // --- EDITING LOGIC ---
        function startEditing(id, text) {
            state.editingMsgId = id;
            els.msgInput.value = text;
            els.editPreview.classList.remove('hidden');
            els.editPreview.classList.add('flex');
            els.inputContainer.classList.add('ring-yellow-300', 'border-yellow-300'); // Yellow tint
            toggleMic(true); // Show send btn (which is now save)
            els.msgInput.focus();
        }

        els.cancelEdit.addEventListener('click', () => {
            state.editingMsgId = null;
            els.msgInput.value = '';
            els.editPreview.classList.add('hidden');
            els.editPreview.classList.remove('flex');
            els.inputContainer.classList.remove('ring-yellow-300', 'border-yellow-300');
            toggleMic(false);
        });

        async function sendMessage(type, content) {
            if (!state.user) { alert("Not connected!"); return; }
            els.sendBtn.disabled = true; els.msgInput.disabled = true;

            // EDIT MODE
            if (state.editingMsgId) {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat_messages', state.editingMsgId), {
                        text: content,
                        edited: true
                    });
                    // Reset UI
                    state.editingMsgId = null;
                    els.editPreview.classList.add('hidden');
                    els.editPreview.classList.remove('flex');
                    els.inputContainer.classList.remove('ring-yellow-300', 'border-yellow-300');
                } catch(e) { alert("Edit failed"); }
                finally {
                    els.sendBtn.disabled = false;
                    els.msgInput.disabled = false;
                    els.msgInput.value = '';
                    toggleMic(false);
                    els.msgInput.focus();
                }
                return;
            }

            // NORMAL SEND
            const payload = {
                sender: state.username,
                senderId: state.user.uid,
                senderAvatar: state.avatar, 
                timestamp: Date.now(),
                read: false,
                deleted: false,
                type: type,
                text: type === 'text' ? content : (type === 'image' ? 'Sent a photo' : (type === 'audio' ? 'Sent a voice note' : 'Started a call')),
            };
            
            if (type === 'image') payload.imageUrl = content;
            if (type === 'audio') payload.audioUrl = content;
            if (state.replyingTo) {
                payload.replyToId = state.replyingTo.id;
                payload.replyToText = state.replyingTo.text;
                payload.replyToSender = state.replyingTo.sender;
                state.replyingTo = null;
                els.replyPreview.classList.add('hidden');
                els.replyPreview.classList.remove('flex');
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), payload);
                updateTyping(false);
            } catch (e) { alert("Send failed."); } 
            finally { els.sendBtn.disabled = false; els.msgInput.disabled = false; els.msgInput.focus(); }
        }

        const handleSendAction = () => {
            const text = els.msgInput.value.trim();
            if (!text) return;
            // Clear input logic moved to sendMessage/finally to handle edits better
            if (!state.editingMsgId) {
                els.msgInput.value = '';
                toggleMic(true);
            }
            sendMessage('text', text);
        };

        els.sendBtn.addEventListener('click', handleSendAction);
        els.msgInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleSendAction(); } });
        els.msgInput.addEventListener('input', () => {
            toggleMic(!els.msgInput.value.trim());
            updateTyping(true);
            if (state.typingTimer) clearTimeout(state.typingTimer);
            state.typingTimer = setTimeout(() => updateTyping(false), 2000);
        });

        function toggleMic(showMic) {
            if (state.editingMsgId) {
                // Editing mode: Always show Save icon (Send btn with Save icon)
                els.micBtn.classList.add('hidden');
                els.sendBtn.classList.remove('hidden');
                els.sendIcon.classList.add('hidden');
                els.saveIcon.classList.remove('hidden');
            } else {
                // Normal mode
                els.sendIcon.classList.remove('hidden');
                els.saveIcon.classList.add('hidden');
                
                if (showMic) { els.micBtn.classList.remove('hidden'); els.sendBtn.classList.add('hidden'); } 
                else { els.micBtn.classList.add('hidden'); els.sendBtn.classList.remove('hidden'); }
            }
        }

        els.imgBtn.addEventListener('click', () => els.imgInput.click());
        els.imgInput.addEventListener('change', async (e) => { if(e.target.files[0]) sendMessage('image', await compressImage(e.target.files[0])); });

        async function updateTyping(isTyping) { if(state.username) try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'typing_status', state.username), { isTyping, timestamp: Date.now() }); } catch(e){} }
        function startTypingListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'typing_status'), (snap) => {
                const names = [];
                snap.forEach(d => { if (d.id !== state.username && d.data().isTyping && (Date.now() - d.data().timestamp) < 3000) names.push(d.id); });
                if (names.length) { els.typing.classList.remove('hidden'); els.typingName.textContent = names.join(', '); } else els.typing.classList.add('hidden');
            });
        }

        els.micBtn.addEventListener('mousedown', startRecording); els.micBtn.addEventListener('touchstart', startRecording);
        els.micBtn.addEventListener('mouseup', stopRecording); els.micBtn.addEventListener('touchend', stopRecording);
        async function startRecording(e) {
            e.preventDefault();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                state.mediaRecorder.start();
                els.micBtn.classList.add('bg-red-500', 'text-white', 'animate-pulse');
                els.msgInput.placeholder = "Recording...";
            } catch (err) { alert("Mic permission denied"); }
        }
        function stopRecording(e) {
            e.preventDefault();
            if (!state.mediaRecorder || state.mediaRecorder.state === 'inactive') return;
            state.mediaRecorder.stop();
            els.micBtn.classList.remove('bg-red-500', 'text-white', 'animate-pulse');
            els.msgInput.placeholder = "Message...";
            state.mediaRecorder.onstop = async () => {
                const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
                if (blob.size > 800000) { alert("Too long!"); return; }
                sendMessage('audio', await blobToBase64(blob));
            };
        }

        function compressImage(file, size=800) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > size) { h *= size/w; w = size; } } else { if (h > size) { w *= size/h; h = size; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                };
            });
        }
        function blobToBase64(blob) { return new Promise((resolve) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.readAsDataURL(blob); }); }
    </script>
</body>
</html>
