<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Chat">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/134/134914.png">

    <!-- Android/Samsung PWA Settings -->
    <meta name="theme-color" content="#fdf2f8">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Chat","short_name":"Chat","start_url":".","display":"standalone","background_color":"#fdf2f8","theme_color":"#fdf2f8","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/134/134914.png","sizes":"512x512","type":"image/png"}]}'>

    <title>Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .reaction-menu { transform: scale(0); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); transform-origin: bottom center; }
        .group:hover .reaction-menu { transform: scale(1); }
        
        .typing-dot { animation: bounce 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        /* Audio Player Styling */
        audio::-webkit-media-controls-panel { background-color: white; }
        .dark audio::-webkit-media-controls-panel { background-color: #cbd5e1; }
    </style>
</head>
<body class="bg-pink-50 dark:bg-slate-900 transition-colors duration-200 overflow-hidden h-screen flex flex-col">

    <audio id="notify-sound" src="data:audio/wav;base64,UklGRl9vT1BXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="hidden fixed inset-0 z-50 flex-col items-center justify-center bg-gradient-to-br from-pink-100 to-rose-200 dark:from-slate-800 dark:to-slate-900 p-4 transition-colors">
        <div class="bg-white dark:bg-slate-800 p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-2 border-pink-100 dark:border-slate-700 relative transition-colors">
            
            <!-- Avatar Upload -->
            <div class="relative w-24 h-24 mx-auto mb-6 group cursor-pointer" onclick="document.getElementById('login-avatar-input').click()">
                <div id="login-avatar-preview" class="w-full h-full rounded-full bg-pink-100 dark:bg-slate-700 overflow-hidden border-4 border-white dark:border-slate-600 shadow-md flex items-center justify-center">
                    <svg class="w-10 h-10 text-pink-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                </div>
                <div class="absolute bottom-0 right-0 bg-blue-500 text-white p-1.5 rounded-full shadow-lg">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <input type="file" id="login-avatar-input" accept="image/*" class="hidden">
            </div>
            
            <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-2">Chat</h1>
            <p class="text-gray-500 dark:text-gray-400 mb-6">Set a photo & name to join.</p>
            
            <div id="connection-status" class="mb-4 text-sm font-medium text-yellow-600 bg-yellow-50 py-2 px-3 rounded-lg hidden">Connecting...</div>

            <form id="login-form" class="space-y-4">
                <input type="text" id="username-input" placeholder="Your Name" class="w-full px-4 py-3 border border-gray-200 dark:border-slate-600 rounded-xl focus:outline-none focus:ring-2 focus:ring-pink-400 bg-white dark:bg-slate-700 dark:text-white transition-all text-center font-bold" required>
                <button type="submit" id="login-btn" class="w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-xl transition-colors shadow-lg shadow-pink-200 dark:shadow-none disabled:opacity-50">Start Chatting</button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app-screen" class="hidden flex-col h-full w-full">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 px-4 py-3 pt-safe-top shadow-sm flex items-center justify-between z-20 border-b border-gray-200 dark:border-slate-700">
            <div class="flex items-center gap-3">
                <div id="header-avatar" class="w-10 h-10 rounded-full bg-gradient-to-tr from-pink-400 to-rose-500 flex items-center justify-center text-white font-bold shadow-inner overflow-hidden">
                    <!-- Img or Initial -->
                </div>
                <div>
                    <h2 class="font-bold text-lg text-gray-800 dark:text-white flex items-center gap-1">Chat <span class="text-pink-500">❤️</span></h2>
                    <p class="text-[10px] text-green-500 flex items-center gap-1 font-bold uppercase tracking-wider"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Online</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button id="theme-toggle" class="p-2 text-gray-400 hover:bg-gray-100 dark:hover:bg-slate-700 rounded-full">
                    <svg id="moon-icon" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg id="sun-icon" class="w-5 h-5 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
                <button id="logout-btn" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-slate-700 rounded-full">
                    <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                </button>
            </div>
        </header>

        <!-- Messages Area -->
        <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-6 bg-pink-50 dark:bg-slate-900 relative scroll-smooth">
            <div id="messages-list" class="max-w-4xl mx-auto w-full space-y-4 pb-4"></div>
            <!-- Typing Indicator -->
            <div id="typing-indicator" class="hidden absolute bottom-2 left-6 z-20 text-xs font-medium text-gray-500 dark:text-gray-400 bg-white/90 dark:bg-slate-800/90 px-3 py-1.5 rounded-full shadow-sm border border-gray-100 dark:border-slate-700 animate-pulse flex items-center gap-1">
                <span id="typing-names">Someone</span> is typing <span class="flex gap-0.5"><span class="typing-dot">.</span><span class="typing-dot">.</span><span class="typing-dot">.</span></span>
            </div>
        </div>

        <!-- GIF/Sticker Picker (Hidden) -->
        <div id="sticker-picker" class="hidden fixed bottom-20 left-4 right-4 md:left-auto md:right-20 md:w-80 h-64 bg-white dark:bg-slate-800 rounded-2xl shadow-2xl border border-gray-200 dark:border-slate-700 z-30 flex flex-col overflow-hidden">
            <div class="p-2 bg-gray-50 dark:bg-slate-900 border-b border-gray-100 dark:border-slate-700 flex justify-between items-center">
                <span class="text-xs font-bold text-gray-500 uppercase">Cute Stickers</span>
                <button id="close-stickers" class="text-gray-400 hover:text-gray-600"><svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="flex-1 overflow-y-auto p-2 grid grid-cols-3 gap-2" id="sticker-grid">
                <!-- Stickers injected by JS -->
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white dark:bg-slate-800 p-3 md:p-4 border-t border-gray-200 dark:border-slate-700 w-full z-20 safe-pb">
            <div class="max-w-4xl mx-auto w-full">
                <!-- Reply Banner -->
                <div id="reply-preview" class="hidden flex items-center justify-between bg-pink-50 dark:bg-slate-700/50 p-2 px-3 rounded-t-xl border-l-4 border-pink-500 mb-2 text-xs">
                    <div class="overflow-hidden"><p class="font-bold text-pink-500 mb-0.5">Replying to <span id="reply-to-name">User</span></p><p id="reply-to-text" class="text-gray-600 dark:text-gray-300 truncate">...</p></div>
                    <button id="cancel-reply" class="p-1 hover:bg-black/5 rounded-full"><svg class="w-3.5 h-3.5 opacity-50" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>

                <div class="flex items-end gap-2">
                    <!-- Attachments -->
                    <div class="flex gap-1 pb-2">
                        <input type="file" id="image-input" accept="image/*" class="hidden">
                        <button id="image-btn" class="p-2 text-gray-400 hover:text-pink-500 transition-colors" title="Photo"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg></button>
                        <button id="sticker-btn" class="p-2 text-gray-400 hover:text-yellow-500 transition-colors" title="Stickers"><svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg></button>
                    </div>

                    <!-- Text Input -->
                    <div class="flex-1 bg-gray-100 dark:bg-slate-900 rounded-2xl border border-gray-200 dark:border-slate-700 focus-within:ring-2 focus-within:ring-pink-200 dark:focus-within:ring-slate-600 transition-all flex items-center min-h-[44px]">
                        <input type="text" id="message-input" class="w-full bg-transparent border-none outline-none text-gray-800 dark:text-gray-100 placeholder-gray-400 text-base px-4 py-2" placeholder="Message..." autocomplete="off">
                    </div>

                    <!-- Mic / Send -->
                    <div class="pb-1">
                        <button id="send-btn" type="submit" class="hidden bg-pink-500 hover:bg-pink-600 text-white p-2.5 rounded-full shadow-lg transition-transform active:scale-95 disabled:bg-gray-400 disabled:cursor-not-allowed"><svg class="w-5 h-5 ml-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button>
                        <button id="mic-btn" type="button" class="bg-gray-200 dark:bg-slate-700 hover:bg-gray-300 text-gray-600 dark:text-gray-300 p-2.5 rounded-full shadow transition-colors"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-pink-50 dark:bg-slate-900"><svg class="w-16 h-16 text-pink-500 animate-pulse fill-current" viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- STICKER DATA ---
        const STICKERS = [
            "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDN4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/Mdf5HYOZgrem6vC2G0/giphy.gif",
            "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDN4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/13CoXDiaCcCoyk/giphy.gif",
            "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDN4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/R6gvnAxj2ISzJdbA63/giphy.gif",
            "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDN4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/MDJ9IbxxvDuQM/giphy.gif",
            "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDN4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/GCLlQnV7hPyKy0524L/giphy.gif",
            "https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDN4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eHM3eDZnZ2Z4eCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/26FLdmIp6wJr91JAI/giphy.gif"
        ];

        const firebaseConfig = {
            apiKey: "AIzaSyCuDu_yuMRmXTi7N3tdMJckLnuHyQ2tcsc",
            authDomain: "messageapp-98066.firebaseapp.com",
            projectId: "messageapp-98066",
            storageBucket: "messageapp-98066.firebasestorage.app",
            messagingSenderId: "647948804998",
            appId: "1:647948804998:web:bd0eebd3f97f9853f18207",
            measurementId: "G-H096MFHK6K"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "love-chat";

        // ELEMENTS
        const els = {
            loginScreen: document.getElementById('login-screen'),
            appScreen: document.getElementById('app-screen'),
            loadingScreen: document.getElementById('loading-screen'),
            loginForm: document.getElementById('login-form'),
            username: document.getElementById('username-input'),
            msgForm: document.getElementById('message-form'),
            msgInput: document.getElementById('message-input'),
            msgList: document.getElementById('messages-list'),
            msgContainer: document.getElementById('messages-container'),
            headerAvatar: document.getElementById('header-avatar'),
            avatarPreview: document.getElementById('login-avatar-preview'),
            avatarInput: document.getElementById('login-avatar-input'),
            sendBtn: document.getElementById('send-btn'),
            micBtn: document.getElementById('mic-btn'),
            stickerBtn: document.getElementById('sticker-btn'),
            stickerPicker: document.getElementById('sticker-picker'),
            stickerGrid: document.getElementById('sticker-grid'),
            closeStickers: document.getElementById('close-stickers'),
            replyPreview: document.getElementById('reply-preview'),
            replyName: document.getElementById('reply-to-name'),
            replyText: document.getElementById('reply-to-text'),
            cancelReply: document.getElementById('cancel-reply'),
            imgInput: document.getElementById('image-input'),
            imgBtn: document.getElementById('image-btn'),
            typing: document.getElementById('typing-indicator'),
            typingName: document.getElementById('typing-names'),
            notifySound: document.getElementById('notify-sound'),
            logoutBtn: document.getElementById('logout-btn'),
            themeToggle: document.getElementById('theme-toggle'),
            moon: document.getElementById('moon-icon'),
            sun: document.getElementById('sun-icon')
        };

        let state = {
            user: null,
            username: localStorage.getItem('chat_username') || '',
            avatar: localStorage.getItem('chat_avatar') || null,
            replyingTo: null,
            typingTimer: null,
            mediaRecorder: null,
            audioChunks: []
        };

        // --- INIT ---
        function initTheme() {
            if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                els.moon.classList.add('hidden');
                els.sun.classList.remove('hidden');
            }
        }
        initTheme();

        // --- AUTH ---
        onAuthStateChanged(auth, (u) => {
            state.user = u;
            els.loadingScreen.classList.add('hidden');
            if (u) {
                if (state.username) showApp();
                else showLogin();
            } else {
                signInAnonymously(auth).catch(console.error);
                showLogin();
            }
        });

        function showLogin() {
            els.loginScreen.classList.remove('hidden');
            els.loginScreen.classList.add('flex');
            els.appScreen.classList.add('hidden');
            els.appScreen.classList.remove('flex');
        }

        function showApp() {
            els.loginScreen.classList.add('hidden');
            els.loginScreen.classList.remove('flex');
            els.appScreen.classList.remove('hidden');
            els.appScreen.classList.add('flex');
            
            // Render Header Avatar
            if (state.avatar) {
                els.headerAvatar.innerHTML = `<img src="${state.avatar}" class="w-full h-full object-cover">`;
            } else {
                els.headerAvatar.textContent = state.username.charAt(0).toUpperCase();
            }

            if (Notification.permission === 'default') setTimeout(() => Notification.requestPermission(), 1000);
            
            startMessageListener();
            startTypingListener();
        }

        // --- LOGIN LOGIC ---
        els.avatarInput.addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                const base64 = await compressImage(e.target.files[0], 150); // Tiny thumbnail
                state.avatar = base64;
                els.avatarPreview.innerHTML = `<img src="${base64}" class="w-full h-full object-cover">`;
            }
        });

        els.loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const val = els.username.value.trim();
            if (!val) return;
            state.username = val;
            localStorage.setItem('chat_username', val);
            if (state.avatar) localStorage.setItem('chat_avatar', state.avatar);
            if (state.user) showApp();
        });

        els.logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('chat_username');
            localStorage.removeItem('chat_avatar');
            state.username = '';
            state.avatar = null;
            showLogin();
        });

        els.themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
            localStorage.theme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
            els.moon.classList.toggle('hidden');
            els.sun.classList.toggle('hidden');
        });

        // --- MESSAGING LOGIC ---
        function startMessageListener() {
            const q = collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages');
            onSnapshot(q, (snapshot) => {
                const msgs = snapshot.docs.map(d => ({ id: d.id, ...d.data() })).sort((a, b) => a.timestamp - b.timestamp);
                
                // Read Receipts & Notifications
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        // Notify
                        if (data.sender !== state.username && (Date.now() - data.timestamp) < 5000) {
                            els.notifySound.play().catch(e=>{});
                            if (Notification.permission === "granted" && document.visibilityState === "hidden") {
                                try { new Notification(data.sender, { body: data.text || 'Sent a media' }); } catch(e){}
                            }
                        }
                        // Mark as read if it's not mine
                        if (data.sender !== state.username && !data.read) {
                            // Don't update immediately to avoid loop, do it once
                            updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat_messages', change.doc.id), { read: true }).catch(e=>{});
                        }
                    }
                });

                renderMessages(msgs);
            }, (error) => {
                console.error("Database Error:", error);
            });
        }

        function renderMessages(msgs) {
            let html = '';
            let lastDate = null;

            msgs.forEach(msg => {
                const isMe = msg.sender === state.username;
                const date = new Date(msg.timestamp);
                const dayStr = date.toLocaleDateString();
                
                // Date Separator
                if (dayStr !== lastDate) {
                    let label = dayStr;
                    const today = new Date().toLocaleDateString();
                    if (dayStr === today) label = "Today";
                    html += `<div class="text-center text-[10px] text-gray-400 font-bold uppercase tracking-widest my-4 opacity-70">${label}</div>`;
                    lastDate = dayStr;
                }

                // Components
                const avatarHtml = !isMe 
                    ? `<div class="w-8 h-8 rounded-full bg-gray-200 dark:bg-slate-700 overflow-hidden flex-shrink-0 mt-1 shadow-sm border border-white dark:border-slate-600">
                        ${msg.senderAvatar ? `<img src="${msg.senderAvatar}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-[10px] font-bold text-gray-500">${msg.sender[0]}</div>`}
                       </div>` 
                    : '';
                
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Read Ticks
                let ticks = '';
                if (isMe) {
                    const color = msg.read ? 'text-blue-400' : 'text-gray-300';
                    if (msg.read) ticks = `<span class="text-blue-400 ml-1 flex -space-x-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>`;
                    else ticks = `<span class="text-gray-300 ml-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></span>`;
                }

                // Content
                let content = `<p>${msg.text}</p>`;
                if (msg.deleted) content = `<p class="italic opacity-60 text-sm flex items-center gap-1"><svg class="w-3 h-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg> Deleted</p>`;
                else if (msg.type === 'image') content = `<img src="${msg.imageUrl}" class="rounded-lg max-h-64 w-auto border border-black/10">`;
                else if (msg.type === 'audio') content = `<audio controls src="${msg.audioUrl}" class="h-8 w-48"></audio>`;

                // Reply
                let reply = '';
                if (msg.replyToText && !msg.deleted) {
                    reply = `<div class="mb-1 text-[10px] opacity-70 border-l-2 border-current pl-2 truncate cursor-pointer"><b>${msg.replyToSender}</b>: ${msg.replyToText}</div>`;
                }

                // Data Attributes for Actions
                const encodedText = encodeURIComponent(msg.text || '');
                const actionBtns = !msg.deleted ? `
                    <div class="absolute -top-6 ${isMe ? 'right-0' : 'left-0'} hidden group-hover:flex bg-white dark:bg-slate-700 shadow rounded-full p-1 border dark:border-slate-600 gap-1">
                        <button data-action="reply" data-id="${msg.id}" data-sender="${msg.sender}" data-type="${msg.type}" data-text="${encodedText}" class="p-1 hover:bg-gray-100 dark:hover:bg-slate-600 rounded-full text-gray-500"><svg class="w-3 h-3 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 14L4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg></button>
                        ${isMe ? `<button data-action="delete" data-id="${msg.id}" class="p-1 hover:bg-red-50 text-gray-500 hover:text-red-500 rounded-full"><svg class="w-3 h-3 pointer-events-none" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>` : ''}
                    </div>` : '';

                html += `
                    <div class="flex gap-2 ${isMe ? 'justify-end' : 'justify-start'} group mb-1">
                        ${!isMe ? avatarHtml : ''}
                        <div class="max-w-[75%] relative">
                            <div class="px-4 py-2 rounded-2xl shadow-sm border ${isMe ? 'bg-pink-500 text-white border-pink-600 rounded-br-none' : 'bg-white dark:bg-slate-800 text-gray-800 dark:text-gray-100 border-gray-200 dark:border-slate-700 rounded-bl-none'}">
                                ${reply}
                                ${content}
                                <div class="flex items-center justify-end gap-1 mt-1">
                                    <span class="text-[9px] opacity-70">${timeStr}</span>
                                    ${ticks}
                                </div>
                            </div>
                            ${actionBtns}
                        </div>
                    </div>
                `;
            });
            els.msgList.innerHTML = html;
            if(els.msgContainer.scrollTop + els.msgContainer.clientHeight >= els.msgContainer.scrollHeight - 100) {
                els.msgContainer.scrollTop = els.msgContainer.scrollHeight;
            }
        }

        // --- DELEGATED ACTIONS ---
        els.msgList.addEventListener('click', (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;
            const action = btn.dataset.action;
            if (!action) return;

            if (action === 'reply') {
                const text = decodeURIComponent(btn.dataset.text);
                const type = btn.dataset.type;
                const displayText = type === 'image' ? 'Photo' : (type === 'audio' ? 'Voice Note' : text);
                
                state.replyingTo = { id: btn.dataset.id, sender: btn.dataset.sender, text: displayText };
                els.replyPreview.classList.remove('hidden');
                els.replyPreview.classList.add('flex');
                els.replyName.textContent = btn.dataset.sender;
                els.replyText.textContent = displayText;
                els.msgInput.focus();
            }
            
            if (action === 'delete') {
                if(confirm("Delete message?")) {
                    updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'chat_messages', btn.dataset.id), { deleted: true, text: 'Deleted', imageUrl: null, audioUrl: null });
                }
            }
        });

        els.cancelReply.addEventListener('click', () => {
            state.replyingTo = null;
            els.replyPreview.classList.add('hidden');
            els.replyPreview.classList.remove('flex');
        });

        // --- SENDING ---
        async function sendMessage(type, content) {
            if (!state.user) { alert("Not connected to chat!"); return; }
            
            els.sendBtn.disabled = true; // Prevent double send
            els.msgInput.disabled = true;

            const payload = {
                sender: state.username,
                senderId: state.user.uid,
                senderAvatar: state.avatar, 
                timestamp: Date.now(),
                read: false,
                deleted: false,
                type: type,
                text: type === 'text' ? content : (type === 'image' ? 'Sent a photo' : 'Sent a voice note'),
            };
            
            if (type === 'image') payload.imageUrl = content;
            if (type === 'audio') payload.audioUrl = content;

            if (state.replyingTo) {
                payload.replyToId = state.replyingTo.id;
                payload.replyToText = state.replyingTo.text;
                payload.replyToSender = state.replyingTo.sender;
                state.replyingTo = null;
                els.replyPreview.classList.add('hidden');
                els.replyPreview.classList.remove('flex');
            }

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'chat_messages'), payload);
                updateTyping(false);
            } catch (e) { 
                console.error(e);
                alert("Error sending message. Check connection."); 
            } finally {
                els.sendBtn.disabled = false;
                els.msgInput.disabled = false;
                els.msgInput.focus();
            }
        }

        els.msgForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = els.msgInput.value.trim();
            if (!text) return;
            els.msgInput.value = '';
            toggleMic(true); 
            sendMessage('text', text);
        });

        els.msgInput.addEventListener('input', () => {
            const hasText = els.msgInput.value.trim().length > 0;
            toggleMic(!hasText);
            updateTyping(true);
            if (state.typingTimer) clearTimeout(state.typingTimer);
            state.typingTimer = setTimeout(() => updateTyping(false), 2000);
        });

        function toggleMic(showMic) {
            if (showMic) {
                els.micBtn.classList.remove('hidden');
                els.sendBtn.classList.add('hidden');
            } else {
                els.micBtn.classList.add('hidden');
                els.sendBtn.classList.remove('hidden');
            }
        }

        // --- VOICE RECORDER ---
        els.micBtn.addEventListener('mousedown', startRecording);
        els.micBtn.addEventListener('touchstart', startRecording);
        els.micBtn.addEventListener('mouseup', stopRecording);
        els.micBtn.addEventListener('touchend', stopRecording);

        async function startRecording(e) {
            e.preventDefault();
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                state.mediaRecorder.ondataavailable = e => state.audioChunks.push(e.data);
                state.mediaRecorder.start();
                els.micBtn.classList.add('bg-red-500', 'text-white', 'animate-pulse');
                els.msgInput.placeholder = "Recording...";
            } catch (err) { alert("Mic permission denied"); }
        }

        function stopRecording(e) {
            e.preventDefault();
            if (!state.mediaRecorder || state.mediaRecorder.state === 'inactive') return;
            state.mediaRecorder.stop();
            els.micBtn.classList.remove('bg-red-500', 'text-white', 'animate-pulse');
            els.msgInput.placeholder = "Message...";
            
            state.mediaRecorder.onstop = async () => {
                const blob = new Blob(state.audioChunks, { type: 'audio/webm' });
                // Check size (1MB limit)
                if (blob.size > 800000) { alert("Voice note too long!"); return; }
                const base64 = await blobToBase64(blob);
                sendMessage('audio', base64);
            };
        }

        // --- STICKERS ---
        els.stickerBtn.addEventListener('click', () => {
            els.stickerPicker.classList.remove('hidden');
            if (!els.stickerGrid.innerHTML) {
                els.stickerGrid.innerHTML = STICKERS.map(url => 
                    `<img src="${url}" class="w-full h-20 object-cover rounded cursor-pointer hover:opacity-80 transition-opacity" onclick="window.sendSticker('${url}')">`
                ).join('');
            }
        });
        els.closeStickers.addEventListener('click', () => els.stickerPicker.classList.add('hidden'));
        
        window.sendSticker = (url) => {
            sendMessage('image', url);
            els.stickerPicker.classList.add('hidden');
        };

        // --- UTILS ---
        els.imgBtn.addEventListener('click', () => els.imgInput.click());
        els.imgInput.addEventListener('change', async (e) => {
            if(e.target.files[0]) {
                const base64 = await compressImage(e.target.files[0]);
                sendMessage('image', base64);
            }
        });

        async function updateTyping(isTyping) {
            if (!state.username) return;
            try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'typing_status', state.username), { isTyping, timestamp: Date.now() }); } catch(e){}
        }

        function startTypingListener() {
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'typing_status'), (snap) => {
                const names = [];
                snap.forEach(d => {
                    if (d.id !== state.username && d.data().isTyping && (Date.now() - d.data().timestamp) < 3000) names.push(d.id);
                });
                if (names.length) {
                    els.typing.classList.remove('hidden');
                    els.typingName.textContent = names.join(', ');
                } else els.typing.classList.add('hidden');
            });
        }

        function compressImage(file, size=800) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        if (w > h) { if (w > size) { h *= size/w; w = size; } } 
                        else { if (h > size) { w *= size/h; h = size; } }
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                };
            });
        }

        function blobToBase64(blob) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }
    </script>
</body>
</html>
